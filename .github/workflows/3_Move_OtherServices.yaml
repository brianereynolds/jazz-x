name: 4. Move Other Services

on:
  workflow_dispatch:
    inputs:
      colour:
        description: "Colour to move services TO"
        required: true
        type: choice
        options:
          - blue
          - green

jobs:
  do_move:
    runs-on: ubuntu-latest
    steps:
      - name: Set up Kubernetes CLI
        uses: azure/setup-kubectl@v3

      - name: Configure Kubeconfig
        run: |
          mkdir -p $HOME/.kube/
          echo "${{ secrets.KUBECONFIG }}" > $HOME/.kube/config
          export KUBECONFIG=$HOME/.kube/config

      - name: Move Configuration Service
        run: |
          SUB_ID=${{ vars.SUB_ID }}
          RESOURCE_GROUP=${{ vars.RESOURCE_GROUP }}
          CLUSTER_NAME=${{ vars.CLUSTER_NAME }}
          K8S_VERSION=${{ inputs.version }}
          COLOUR=${{ inputs.colour }}
        
          cat <<EOF | kubectl apply -n operations -f -
          apiVersion: k8smanagers.greyridge.com/v1
          kind: WorkloadManager
          metadata:
            labels:
              app.kubernetes.io/name: workloadmanager
              app.kubernetes.io/managed-by: kustomize
            name: move-config-service
          spec:
            subscriptionId: $SUB_ID
            resourceGroup: $RESOURCE_GROUP
            clusterName: $CLUSTER_NAME
            procedures:
              - description: Move Configuration Service
                type: deployment
                namespace: jazz-x
                workloads: 
                  - cockpit-deployment
                  - equipment-deployment
                  - help-deployment
                  - importexport-deployment
                  - jazz-x-monitoring-deployment
                  - nose-deployment
                  - str-deployment
                  - uia-deployment
                  - wei-deployment
                  - weimon-deployment
                  - wms-deployment
          
                selector: {key: agentpool, initial: irrelevant, target: svcs$COLOUR}
                timeout: 300
          EOF

      - name: Wait for ready
        run: |
          DEPLOYMENTS=("cockpit" "equipment" "help" "importexport" "jazz-x-monitoring" "nose" "str" "uia" "wei" "weimon" "wms")
          
          timeout=300  # Maximum wait time in seconds
          elapsed=0
          
          for deployment in "${DEPLOYMENTS[@]}"; do
            echo "â³ Waiting for deployment: $deployment"
          
            while [[ $(kubectl get deployment "$deployment-deployment" n jazz-x -o json | jq '.status.readyReplicas') -ne $(kubectl get deployment "$deployment-deployment" -n jazz-x -o json | jq '.status.replicas') ]]; do
            if [[ $elapsed -ge $timeout ]]; then
              echo "âŒ Timeout reached! $deployment did not become ready."
              exit 1
            fi
            
            echo "ðŸ”„ Deployment: $deployment - Waiting for pods... ($elapsed/$timeout seconds elapsed)"
            sleep 5
            elapsed=$((elapsed + 10))
            done
          
            echo "âœ… Deployment: $deployment - All pods are ready!"
          done

      - name: Cleanup
        run: |
          kubectl -n operations delete workloadmanager.k8smanagers.greyridge.com/move-config-service
